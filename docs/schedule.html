<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Activity-management | ルーレット</title>
<style>
  :root{
    --bg:#111315; --panel:#1a1d20; --muted:#2a2e33; --muted-2:#3a3f45;
    --text:#e6e8ea; --text-2:#b7bcc2; --brand:#8a92a3; --ok:#7fd1ae; --warn:#e7c888; --err:#d08989;
    --shadow: 0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.4); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,var(--bg),#0e0f10 30%, var(--bg) 100%);
    color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Helvetica, Arial, "Noto Sans JP", "Apple Color Emoji","Segoe UI Emoji";
    display:flex; flex-direction:column; min-height:100dvh;}
  header{position:sticky; z-index:5; top:0; background:rgba(17,19,21,.75); backdrop-filter:saturate(120%) blur(8px); border-bottom:1px solid var(--muted); box-shadow:var(--shadow)}
  .wrap{max-width:980px; margin-inline:auto; padding:14px 16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand .logo{width:36px;height:36px; border-radius:10px; background:linear-gradient(135deg,var(--muted-2),var(--muted)); display:grid; place-items:center; box-shadow:inset 0 0 0 1px #000, 0 6px 18px rgba(0,0,0,.35)}
  h1{font-size:1.15rem; margin:0; letter-spacing:.02em}
  .header-actions{margin-left:auto; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:flex-end}
  .points{display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,var(--muted),var(--muted-2)); border:1px solid #000; box-shadow:inset 0 1px 0 rgba(255,255,255,.05); font-weight:600}
  .points small{color:var(--text-2); font-weight:500}
  main{flex:1;}
  .card{background:linear-gradient(180deg,var(--panel),#15171a); border:1px solid #0a0b0c; border-radius:var(--radius); box-shadow:var(--shadow)}
  .card .body{padding:16px}
  .card h2{font-size:1rem; margin:0 0 4px}
  .hint{font-size:.9rem; color:var(--text-2); margin:0}
  .fade-in{animation:fade .25s ease-out}
  @keyframes fade {from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)} }
  .section-head{display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap}
  .stat{margin-left:auto; padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#2d3238,#24282d); border:1px solid #000; color:var(--text); font-weight:700; display:inline-flex; align-items:center; gap:6px}
  .stat small{color:var(--text-2); font-weight:500}
  .roulette-area{display:grid; grid-template-columns:1fr; gap:18px; align-items:center; margin-top:16px}
  .wheel-wrap{position:relative; display:grid; place-items:center; padding:10px}
  .wheel{width:min(320px,70vw); aspect-ratio:1; border-radius:50%; border:10px solid #0d0f11; box-shadow:inset 0 0 0 1px #000, var(--shadow);
    background:conic-gradient(from -90deg, #5fa383 0deg 72deg, #2b3036 72deg 144deg, #2e3339 144deg 216deg, #30353c 216deg 288deg, #323941 288deg 360deg);
    display:grid; place-items:center; position:relative; overflow:hidden; transform:rotate(var(--rotation, 0deg)); transition:transform 1.15s cubic-bezier(.18,.67,.28,.99);
  }
  .wheel::after{content:""; position:absolute; inset:18%; border-radius:50%; background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), rgba(255,255,255,0)); border:1px solid #0a0b0c}
  .wheel-label{position:relative; z-index:2; background:rgba(0,0,0,.45); color:var(--text); border-radius:50%; width:120px; height:120px; display:grid; place-items:center; text-align:center; font-weight:700; letter-spacing:.04em; box-shadow:inset 0 0 0 1px #000, 0 4px 14px rgba(0,0,0,.35)}
  .pointer{position:absolute; top:-12px; width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:22px solid #d6d9de; filter:drop-shadow(0 4px 6px rgba(0,0,0,.5))}
  .control{background:rgba(10,11,12,.55); border:1px solid #0c0d0f; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)}
  .info-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px}
  .pill{padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#2b3036,#23272c); border:1px solid #000; color:var(--text); font-weight:600; text-align:center}
  .pill small{display:block; color:var(--text-2); font-weight:500; margin-bottom:2px}
  .btn{padding:12px 14px; border-radius:12px; border:1px solid #000; background:linear-gradient(180deg,#6c737d,#484e56); color:var(--text); font-weight:700; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px; text-decoration:none}
  .btn:hover{filter:brightness(1.06)}
  .btn:disabled{opacity:.5; cursor:not-allowed; filter:grayscale(.2)}
  .note{color:var(--text-2); font-size:.9rem}
  .warning{color:var(--err)}
  .result{font-size:1rem; font-weight:700; padding:10px 12px; border-radius:10px; border:1px solid #0b0d0f; background:linear-gradient(180deg,#16181b,#111315);}
  .result.win{border-color:#2f5748; background:linear-gradient(180deg,#1e3027,#111715); color:var(--ok)}
  .result.lose{border-color:#3a2b2b; background:linear-gradient(180deg,#221616,#111313); color:#e3b0b0}
  .history{display:flex; flex-direction:column; gap:8px}
  .history-item{padding:10px 12px; border-radius:10px; background:#0f1113; border:1px solid #0b0c0d; color:var(--text-2); font-size:.9rem; display:flex; align-items:center; gap:8px}
  .history-item .badge{font-size:.85rem; padding:4px 8px; border-radius:999px; border:1px solid #000; background:linear-gradient(180deg,#2b3036,#23272c); color:var(--text)}
  .history-empty{color:var(--text-2); font-size:.9rem}
  footer{margin-top:auto; color:var(--text-2); font-size:.8rem; text-align:center; padding:18px 12px}
  @media(min-width:900px){ .roulette-area{grid-template-columns:1.1fr 1fr} }
  @media (max-width: 520px){
    header{border-bottom:1px solid #0b0c0d}
    header .wrap{padding:8px 12px}
    .brand{display:flex; align-items:center; gap:10px; flex-wrap:nowrap}
    .brand .logo{width:28px; height:28px; border-radius:8px}
    h1{font-size:1rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .header-actions{margin-left:auto; gap:10px; justify-content:flex-end}
    .points{padding:6px 10px; gap:8px; font-size:.95rem; line-height:1}
    .points #breakdown{display:none}
  }
  @media (max-width: 380px){
    h1{font-size:.95rem}
    .points{font-size:.9rem}
  }
</style>
<link href="/manifest.webmanifest" rel="manifest"/><meta content="#111315" name="theme-color"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><link href="/icons/icon-192.png" rel="apple-touch-icon"/>
</head>
<body>
<header>
  <div class="wrap brand">
    <div aria-hidden="true" class="logo">
      <svg fill="none" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><rect height="18" rx="4" stroke="#9aa3b1" width="18" x="3" y="3"></rect><path d="M7 14.5L10 11l3 3 4-6" stroke="#9aa3b1" stroke-width="1.5"></path></svg>
    </div>
    <h1>ルーレット</h1>
    <div class="header-actions">
      <label class="view-toggle">
        <input aria-checked="true" aria-label="行動管理とルーレットを切り替え" data-dashboard-href="./index.html" data-page="roulette" data-schedule-href="./schedule.html" id="viewToggle" role="switch" type="checkbox"/>
      </label>
      <div class="points" id="totalPoints"><small class="label">合計</small><span class="total">0</span> pt<small id="breakdown" style="display:none"></small></div>
    </div>
  </div>
</header>
<main>
  <div class="wrap" id="rouletteApp">
    <section class="card fade-in">
      <div class="body">
        <div class="section-head">
          <div>
            <h2>ポイントルーレット</h2>
            <p class="hint">5回に1回の確率で当たり。1回回すと10ポイント消費し、当たれば30ポイント獲得します。</p>
          </div>
          <div class="stat"><small>所持ポイント</small><span id="balanceValue">0</span> pt</div>
        </div>
        <div class="roulette-area">
          <div class="wheel-wrap">
            <div aria-hidden="true" class="pointer"></div>
            <div class="wheel" id="wheel">
              <div class="wheel-label">
                <div>1 / 5</div>
                <div>HIT</div>
              </div>
            </div>
          </div>
          <div class="control">
            <div class="info-grid">
              <div class="pill"><small>消費</small>-10 pt / 回</div>
              <div class="pill"><small>当たり</small>+30 pt</div>
              <div class="pill"><small>確率</small>1 / 5</div>
            </div>
            <div class="result" id="resultMessage" aria-live="polite">結果はここに表示されます。</div>
            <button class="btn" id="spinBtn" type="button">10pt消費して回す</button>
            <div class="note warning" id="warning" style="display:none"></div>
            <div class="history" id="historyList" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>
<footer>
  &copy; Activity-management
</footer>
<script>
(function(){
  const STORE_KEY = 'behavior-tracker-v4';
  const SPEND_LOG_MAX = 500;
  const ACTIVITY_LOG_MAX = 500;
  const COST = 10;
  const REWARD = 30;
  const WIN_RATE = 0.2;
  const MAX_HISTORY = 6;

  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinBtn');
  const resultMessage = document.getElementById('resultMessage');
  const warning = document.getElementById('warning');
  const historyList = document.getElementById('historyList');
  const totalEl = document.querySelector('#totalPoints .total');
  const breakdownEl = document.getElementById('breakdown');
  const balanceValue = document.getElementById('balanceValue');
  const viewToggle = document.getElementById('viewToggle');

  let store = null;
  let currentRotation = 0;
  let spinning = false;
  const history = [];

  if(viewToggle){
    const currentPage = viewToggle.dataset.page || '';
    const scheduleHref = viewToggle.dataset.scheduleHref;
    const dashboardHref = viewToggle.dataset.dashboardHref;
    const isSchedule = currentPage === 'roulette';
    viewToggle.checked = isSchedule;
    viewToggle.setAttribute('aria-checked', isSchedule ? 'true' : 'false');
    viewToggle.addEventListener('change', event => {
      const checked = event.target.checked;
      event.target.setAttribute('aria-checked', checked ? 'true' : 'false');
      if(checked && scheduleHref && currentPage !== 'roulette'){
        window.location.href = scheduleHref;
      }else if(!checked && dashboardHref && currentPage === 'roulette'){
        window.location.href = dashboardHref;
      }
    });
  }

  function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }
  function loadStore(){
    try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'{}'); }
    catch{ store = {}; }
    if(!store || typeof store !== 'object') store = { currentUserId:null, users:{} };
    if(!store.users) store.users = {};
    return store;
  }
  function ensureMeta(){
    if(!store) loadStore();
    const uid = store.currentUserId;
    if(!uid) return null;
    if(!store.users[uid]){
      store.users[uid] = { passwordHash:null, items:[], spent:0, spendLog:[], earned:0, activityLog:[] };
      saveStore();
    }
    const meta = store.users[uid];
    if(!Array.isArray(meta.items)) meta.items = [];
    if(!Array.isArray(meta.spendLog)) meta.spendLog = [];
    if(!Array.isArray(meta.activityLog)) meta.activityLog = [];
    if(typeof meta.spent !== 'number') meta.spent = 0;
    if(typeof meta.earned !== 'number') meta.earned = 0;
    return meta;
  }

  function earnedFromList(meta){
    const items = Array.isArray(meta?.items) ? meta.items : [];
    let total = 0;
    for(const item of items){
      const diff = Number(item?.difficulty) || 0;
      const count = Math.max(0, Number(item?.completedCount) || 0);
      total += diff * count;
    }
    return total;
  }

  function computeBalance(){
    const meta = ensureMeta();
    if(!meta) return 0;
    const earned = earnedFromList(meta) + (Number(meta.earned)||0);
    const spent = Math.max(0, Number(meta.spent)||0);
    return Math.max(0, earned - spent);
  }

  function pushSpendLog(meta, entry){
    const logs = Array.isArray(meta.spendLog) ? meta.spendLog : [];
    logs.push(entry);
    if(logs.length > SPEND_LOG_MAX){ logs.splice(0, logs.length - SPEND_LOG_MAX); }
    meta.spendLog = logs;
  }

  function addActivity(meta, kind, message){
    if(!meta) return;
    meta.activityLog.push({ id: `act-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`, kind, message, at: Date.now() });
    if(meta.activityLog.length > ACTIVITY_LOG_MAX){
      meta.activityLog.splice(0, meta.activityLog.length - ACTIVITY_LOG_MAX);
    }
  }

  function setResult(message, tone){
    resultMessage.textContent = message;
    resultMessage.classList.remove('win','lose');
    if(tone) resultMessage.classList.add(tone);
  }

  function renderHistory(){
    historyList.innerHTML = '';
    if(!history.length){
      const empty = document.createElement('div');
      empty.className = 'history-empty';
      empty.textContent = 'まだ結果がありません。';
      historyList.appendChild(empty);
      return;
    }
    history.forEach(entry => {
      const item = document.createElement('div');
      item.className = 'history-item fade-in';
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = entry.win ? '当たり' : 'ハズレ';
      const text = document.createElement('div');
      text.textContent = `${entry.label} - ${entry.at}`;
      item.appendChild(badge);
      item.appendChild(text);
      historyList.appendChild(item);
    });
  }

  function fmt(ts){
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${y}/${m}/${da} ${hh}:${mm}`;
  }

  function updateHeader(){
    const meta = ensureMeta();
    const total = computeBalance();
    if(totalEl) totalEl.textContent = String(total);
    if(breakdownEl){
      if(meta){
        breakdownEl.textContent = `(取得 ${earnedFromList(meta)+(Number(meta.earned)||0)} / 消費 ${Math.max(0, Number(meta.spent)||0)})`;
        breakdownEl.style.display = 'inline';
      } else {
        breakdownEl.textContent = '';
        breakdownEl.style.display = 'none';
      }
    }
    if(balanceValue) balanceValue.textContent = String(total);
    const metaExists = Boolean(meta);
    const insufficient = total < COST;
    spinBtn.disabled = spinning || !metaExists || insufficient;
    if(!metaExists){
      warning.textContent = 'ダッシュボードでユーザーを作成するとポイントが反映されます。';
      warning.style.display = 'block';
    } else if(insufficient){
      warning.textContent = 'ポイントが足りません。';
      warning.style.display = 'block';
    } else {
      warning.textContent = '';
      warning.style.display = 'none';
    }
  }

  function spin(){
    if(spinning) return;
    const meta = ensureMeta();
    if(!meta){
      setResult('ユーザーが未選択です。ダッシュボードで設定してください。', 'lose');
      updateHeader();
      return;
    }
    const balance = computeBalance();
    if(balance < COST){
      setResult('ポイントが足りません。', 'lose');
      updateHeader();
      return;
    }
    spinning = true;
    spinBtn.disabled = true;
    warning.style.display = 'none';

    const isWin = Math.random() < WIN_RATE;
    const segments = 5;
    const segmentAngle = 360 / segments;
    const targetIndex = isWin ? 0 : (1 + Math.floor(Math.random() * (segments - 1)));
    const spins = 4 + Math.floor(Math.random() * 3);
    currentRotation += spins * 360 + segmentAngle * targetIndex + 14;
    wheel.style.setProperty('--rotation', `${currentRotation}deg`);

    setTimeout(()=>{
      const now = Date.now();
      meta.spent = Math.max(0, Number(meta.spent)||0) + COST;
      pushSpendLog(meta, { id: `log-${now.toString(36)}`, type:'spend', what:'ルーレット', amt:COST, at: now });
      addActivity(meta, 'spend', `ルーレット (-${COST}pt)`);

      if(isWin){
        meta.earned = Math.max(0, Number(meta.earned)||0) + REWARD;
        pushSpendLog(meta, { id: `log-${(now+1).toString(36)}`, type:'earn', what:'ルーレット当たり', amt:REWARD, at: now + 1 });
        addActivity(meta, 'earn', `ルーレット当たり (+${REWARD}pt)`);
        setResult('当たり！ 30ポイント獲得！', 'win');
      } else {
        setResult('ハズレ… また挑戦してみましょう。', 'lose');
      }

      saveStore();
      const entry = { win:isWin, at: fmt(now), label: isWin ? '+30pt' : '-10pt' };
      history.unshift(entry);
      if(history.length > MAX_HISTORY){ history.pop(); }
      renderHistory();
      spinning = false;
      updateHeader();
    }, 1200);
  }

  spinBtn.addEventListener('click', spin);
  loadStore();
  updateHeader();
  renderHistory();
})();
</script>
</body>
</html>
