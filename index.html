<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Activity-management</title>
<style>
  :root{
    --bg:#111315; --panel:#1a1d20; --muted:#2a2e33; --muted-2:#3a3f45;
    --text:#e6e8ea; --text-2:#b7bcc2; --brand:#8a92a3; --ok:#7fd1ae; --warn:#e7c888; --err:#d08989;
    --shadow: 0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.4); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,var(--bg),#0e0f10 30%, var(--bg) 100%);
    color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Helvetica, Arial, "Noto Sans JP", "Apple Color Emoji","Segoe UI Emoji"; 
    display:flex; flex-direction:column; min-height:100dvh;}
  header{position:sticky; z-index:5; top:0; background:rgba(17,19,21,.75); backdrop-filter:saturate(120%) blur(8px); border-bottom:1px solid var(--muted); box-shadow:var(--shadow)}
  .wrap{max-width:980px; margin-inline:auto; padding:14px 16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand .logo{width:36px;height:36px; border-radius:10px; background:linear-gradient(135deg,var(--muted-2),var(--muted)); display:grid; place-items:center; box-shadow:inset 0 0 0 1px #000, 0 6px 18px rgba(0,0,0,.35)}
  h1{font-size:1.15rem; margin:0; letter-spacing:.02em}
  .header-actions{margin-left:auto; display:flex; align-items:center; gap:12px}
  .points{display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,var(--muted),var(--muted-2)); border:1px solid #000; box-shadow:inset 0 1px 0 rgba(255,255,255,.05); font-weight:600}
  .points small{color:var(--text-2); font-weight:500}
  .icon-btn{all:unset; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border-radius:12px; background:linear-gradient(180deg,#2d3238,#24282d); border:1px solid #000; box-shadow:inset 0 1px 0 rgba(255,255,255,.05); color:var(--text-2); transition:.2s}
  .icon-btn:hover{filter:brightness(1.08)}
  .icon-btn:focus-visible{outline:2px solid var(--brand); outline-offset:2px}
  .icon-btn svg{width:20px; height:20px; fill:none; stroke:var(--text-2); stroke-width:1.6}
  main{flex:1;}
  .grid{display:grid; gap:16px; grid-template-columns:1fr}
  @media(min-width:980px){ .grid{grid-template-columns: 1fr 1.2fr} }
  .card{background:linear-gradient(180deg,var(--panel),#15171a); border:1px solid #0a0b0c; border-radius:var(--radius); box-shadow:var(--shadow)}
  .card h2{font-size:1rem; margin:0 0 10px}
  .card .body{padding:16px}
  .row{display:grid; gap:10px; grid-template-columns:1fr}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  label{font-size:.9rem; color:var(--text-2)}
  input, select, textarea{width:100%; padding:12px 12px; border-radius:12px; background:#0f1113; color:var(--text); border:1px solid var(--muted); outline:none; transition:.2s}
  input:focus, select:focus, textarea:focus{border-color:var(--brand); background:#0d0f11}
  .hint{font-size:.8rem; color:var(--text-2)}
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .btn{padding:10px 14px; border-radius:12px; border:1px solid #000; background:linear-gradient(180deg,#2d3238,#24282d); color:var(--text); font-weight:600; cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:linear-gradient(180deg,#6c737d,#484e56);} 
  .btn.ghost{background:transparent; border:1px dashed var(--muted-2); color:var(--text-2)}
  .btn.ok{background:linear-gradient(180deg,#6a8f7f,#476457)}
  .btn.warn{background:linear-gradient(180deg,#9a8860,#6f6147)}
  .btn.err{background:linear-gradient(180deg,#8f6a6a,#5f4747)}
  .list{display:grid; gap:12px}
  .item{background:linear-gradient(180deg,#15171a,#121416); border:1px solid #0a0b0c; border-radius:14px; padding:12px}
  .item-head{display:flex; align-items:center; gap:10px}
  .badge{font-size:.8rem; padding:4px 8px; border-radius:999px; border:1px solid #000; background:linear-gradient(180deg,#2b3036,#23272c); color:var(--text-2)}
  .date{font-size:.8rem; color:var(--text-2)}
  .title{font-weight:700}
  .muted{color:var(--text-2)}
  .spacer{flex:1}
  .item .bar{height:8px; border-radius:8px; background:#0e1012; border:1px solid #060708; overflow:hidden}
  .item .bar > i{display:block; height:100%; background:linear-gradient(90deg,#6f7680,#9aa3b1)}
  .item .controls{display:flex; gap:8px; flex-wrap:wrap}
  .btn.icon{display:inline-flex; align-items:center; gap:6px}
  .empty{padding:24px; text-align:center; color:var(--text-2)}
  .seg{display:flex; gap:8px}
  .seg .btn{padding:8px 12px}
  .seg .btn[aria-pressed="true"]{outline:2px solid var(--brand)}
  .list-filters{margin-bottom:12px; flex-wrap:wrap}
  .fade-in{animation:fade .25s ease-out}
  @keyframes fade {from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)} }
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); backdrop-filter: blur(4px)}
  .modal.on{display:grid}
  .modal .panel{width:min(560px,92vw); background:linear-gradient(180deg,var(--panel),#14161a); border:1px solid #0a0b0c; border-radius:18px; box-shadow:var(--shadow); padding:18px}
  .modal h3{margin:0 0 10px; font-size:1.05rem}
  .muted2{color:var(--text-2); font-size:.9rem}
  .inline{display:flex; align-items:center; gap:8px}

  /* ===== Header controls (text labels) ===== */
  #settingsBtn svg{stroke:var(--text)}

  /* ===== Mobile header layout (clean) ===== */
  @media (max-width: 520px){
    header{border-bottom:1px solid #0b0c0d}
    header .wrap{padding:8px 12px}
    .brand{display:flex; align-items:center; gap:10px; flex-wrap:nowrap}
    .brand .logo{width:28px; height:28px; border-radius:8px}
    h1{font-size:1rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .header-actions{margin-left:auto; gap:10px}
    .points{padding:6px 10px; gap:8px; font-size:.95rem; line-height:1}
    .icon-btn{width:34px; height:34px; border-radius:10px}
    .points #breakdown{display:none}
  }
  @media (max-width: 380px){
    h1{font-size:.95rem}
    .points{font-size:.9rem}
  }
</style>
<link href="/manifest.webmanifest" rel="manifest"/><meta content="#111315" name="theme-color"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><link href="/icons/icon-192.png" rel="apple-touch-icon"/></head>
<body>
<header>
<div class="wrap brand">
<div aria-hidden="true" class="logo">
<svg fill="none" height="20" viewbox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><rect height="18" rx="4" stroke="#9aa3b1" width="18" x="3" y="3"></rect><path d="M7 14.5L10 11l3 3 4-6" stroke="#9aa3b1" stroke-width="1.5"></path></svg>
</div>
<h1>Activity-management</h1>
<div class="header-actions">
<div class="points" id="totalPoints"><small class="label">åˆè¨ˆ</small><span class="total">0</span> pt<small id="breakdown" style="display:none"></small></div>
<button aria-label="è¨­å®š" class="icon-btn" id="settingsBtn" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path>
<path d="M19.4 13.5a7.6 7.6 0 0 0 .1-3l2-1.5-2-3.5-2.3.7a7.4 7.4 0 0 0-2.5-1.4l-.4-2.4h-4l-.4 2.4a7.4 7.4 0 0 0-2.5 1.4L4.5 5.5l-2 3.5 2 1.5a7.6 7.6 0 0 0 0 3l-2 1.5 2 3.5 2.3-.7a7.4 7.4 0 0 0 2.5 1.4l.4 2.4h4l.4-2.4a7.4 7.4 0 0 0 2.5-1.4l2.3.7 2-3.5-2-1.5Z"></path>
</svg>
</button>
</div>
</div>
</header>
<main>
<div class="wrap grid" id="app">
<!-- Add form -->
<section aria-labelledby="formTitle" class="card fade-in">
<div class="body">
<h2 id="formTitle">æ–°ã—ã„è¡Œå‹•</h2>
<form id="taskForm">
<div class="row">
<div>
<label for="title">è¡Œå‹•å</label>
<input id="title" name="title" placeholder="ä¾‹ï¼šæœ7æ™‚ã«10åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ" required="" type="text"/>
</div>
</div>
<div class="row cols-2">
<div>
<label for="mode">æ¡ä»¶/æ—¥ç¨‹</label>
<select id="mode" name="mode">
<option value="cond">æ¡ä»¶ã§ç®¡ç†</option>
<option value="sched">æ—¥ç¨‹ã§ç®¡ç†</option>
</select>
<p class="hint">ã€Œæ¡ä»¶ã€ã¯è‡ªç”±è¨˜å…¥ã€‚ã€Œæ—¥ç¨‹ã€ã¯æ—¥ä»˜ã¨æ™‚é–“ã‚’æŒ‡å®šã€‚</p>
</div>
<div>
<label for="difficulty">é›£æ˜“åº¦ï¼ˆ1ã€œ10ï¼‰</label>
<input id="difficulty" max="10" min="1" name="difficulty" oninput="document.getElementById('diffOut').textContent=this.value" type="range" value="5"/>
<div class="hint">ç¾åœ¨ï¼š<strong id="diffOut">5</strong> pt</div>
</div>
</div>
<div class="row" id="condRow">
<div>
<label for="condition">æ¡ä»¶ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰</label>
<input id="condition" name="condition" placeholder="ä¾‹ï¼šåœ¨å®…å‹¤å‹™ã®æ—¥ã€å¤•é£Ÿå¾Œãªã©" type="text"/>
</div>
</div>
<div class="row cols-2" id="schedRow" style="display:none">
<div>
<label for="date">æ—¥ä»˜</label>
<input id="date" name="date" type="date"/>
</div>
<div>
<label for="time">æ™‚é–“</label>
<input id="time" name="time" type="time"/>
</div>
</div>
<div class="actions">
<button class="btn primary" type="submit">è¿½åŠ </button>
<button class="btn ghost" id="resetBtn" type="reset">ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</form>
</div>
</section>
<!-- Spend points -->
<section aria-labelledby="rewardsTitle" class="card fade-in">
<div class="body">
<h2 id="rewardsTitle">ã”è¤’ç¾ã‚«ã‚¿ãƒ­ã‚°</h2>
<form id="rewardForm">
<div class="row cols-2">
<div>
<label for="rewardName">ã”è¤’ç¾å</label>
<input id="rewardName" name="rewardName" placeholder="ä¾‹ï¼šã‚«ãƒ•ã‚§ã§ã”è¤’ç¾ãƒ©ãƒ†" required="" type="text"/>
</div>
<div>
<label for="rewardCost">å¿…è¦pt</label>
<input id="rewardCost" min="1" name="rewardCost" step="1" type="number" value="5"/>
</div>
</div>
<div class="actions">
<button class="btn" type="submit">ã”è¤’ç¾ã‚’è¿½åŠ </button>
</div>
</form>
<div class="list" id="rewardsList"></div>
<div class="empty" id="rewardsEmpty">ç™»éŒ²ã•ã‚ŒãŸã”è¤’ç¾ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
</div>
</section>
<!-- Spend points (choose from rewards) -->
<section aria-labelledby="spendTitle" class="card fade-in">
<div class="body">
<h2 id="spendTitle">ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»ï¼ˆã”è¤’ç¾ã‹ã‚‰é¸æŠï¼‰</h2>
<form id="spendForm">
<div class="row">
<div>
<label for="rewardSelect">ã”è¤’ç¾</label>
<select id="rewardSelect" name="rewardSelect" required="">
<option disabled="" selected="" value="">ã”è¤’ç¾ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
</select>
<p class="hint">ã‚«ã‚¿ãƒ­ã‚°ã«ãªã„å ´åˆã¯ã€ä¸Šã®ã€Œã”è¤’ç¾ã‚«ã‚¿ãƒ­ã‚°ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
</div>
</div>
<div class="actions">
<button class="btn warn" type="submit">ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã†</button>
<button class="btn ghost" id="undoLastSpend" type="button">ç›´å‰ã®æ¶ˆè²»ã‚’å–ã‚Šæ¶ˆã™</button>
</div>
</form>
<div aria-live="polite" class="hint" id="spendWarn" style="margin:4px 0 0; color:#d08989; display:none">ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼</div>
<div class="hint" id="spendLogWrap" style="margin-top:8px"></div>
</div>
</section>
<!-- List -->
<section aria-labelledby="listTitle" class="card fade-in">
<div class="body">
<h2 id="listTitle">è¡Œå‹•ãƒªã‚¹ãƒˆ</h2>
<div aria-label="è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ" class="seg list-filters" id="listFilters" role="tablist">
<button aria-pressed="true" class="btn" data-filter="all">ã™ã¹ã¦</button>
<button aria-pressed="false" class="btn" data-filter="cond">æ¡ä»¶</button>
<button aria-pressed="false" class="btn" data-filter="sched">æ—¥ç¨‹</button>
</div>
<div class="list" id="list"></div>
<div class="empty" id="empty">ã¾ã é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
</div>
</section>
<!-- Spend history list (under the action list) -->
<section aria-labelledby="spendListTitle" class="card fade-in">
<div class="body">
<h2 id="spendListTitle">æ¶ˆè²»ãƒªã‚¹ãƒˆ</h2>
<div class="list" id="spendList"></div>
<div class="empty" id="spendEmpty">æ¶ˆè²»å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ã€Œãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
</div>
</section>
</div>
</main>
<!-- Login Modal -->
<div aria-labelledby="loginTitle" aria-modal="true" class="modal on" id="loginModal" role="dialog">
<div class="panel">
<h3 id="loginTitle">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰</h3>
<p class="muted2">ã“ã®ã‚¢ãƒ—ãƒªã¯<strong>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å°‚ç”¨</strong>ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯<strong>ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã ã‘</strong>ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
<form class="row" id="loginForm">
<div>
<label for="userId">ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆåŠè§’è‹±æ•°å­—ãƒ»._- / 3æ–‡å­—ä»¥ä¸Šï¼‰</label>
<input id="userId" name="userId" placeholder="ä¾‹ï¼šyuuta" required="" type="text"/>
</div>
<div>
<label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¿…é ˆï¼‰</label>
<div class="inline">
<input autocomplete="current-password" id="password" minlength="6" name="password" placeholder="6æ–‡å­—ä»¥ä¸Šã‚’æ¨å¥¨" required="" type="password"/>
<label class="inline" style="font-size:.85rem"><input id="showPw1" type="checkbox"/> è¡¨ç¤º</label>
</div>
<p class="hint">åˆå›ã®æ–°è¦ä½œæˆæ™‚ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
</div>
<div class="actions">
<button class="btn primary" type="submit">å…¥ã‚‹</button>
</div>
</form>
</div>
</div>
<!-- Account Settings Modal -->
<div aria-labelledby="acctTitle" aria-modal="true" class="modal" id="acctModal" role="dialog">
<div class="panel">
<h3 id="acctTitle">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
<p class="muted2">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<strong id="accountName">æœªãƒ­ã‚°ã‚¤ãƒ³</strong></p>
<div class="actions" style="justify-content:flex-end; margin:12px 0 4px">
  <button class="btn err" id="logoutBtn" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
<div class="actions" style="justify-content:flex-end; margin:0 0 18px">
  <button class="btn warn" id="clearPointsBtn" type="button">æ‰€æŒãƒã‚¤ãƒ³ãƒˆã‚’å…¨æ¶ˆã—</button>
</div>
<form class="row" id="acctForm">
<div>
<label for="currPw">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
<div class="inline">
<input id="currPw" name="currPw" placeholder="æœªè¨­å®šã®æ–¹ã¯ç©ºæ¬„" type="password">
<label class="inline" style="font-size:.85rem"><input id="showPw2" type="checkbox"/> è¡¨ç¤º</label>
</input></div>
</div>
<div>
<label for="newPw">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
<div class="inline">
<input id="newPw" name="newPw" placeholder="6æ–‡å­—ä»¥ä¸Šæ¨å¥¨" type="password">
<label class="inline" style="font-size:.85rem"><input id="showPw3" type="checkbox"/> è¡¨ç¤º</label>
</input></div>
</div>
<div>
<label for="newPw2">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
<input id="newPw2" name="newPw2" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›" type="password">
</input></div>
<div class="actions">
<button class="btn primary" type="submit">ä¿å­˜</button>
<button class="btn" id="acctClose" type="button">é–‰ã˜ã‚‹</button>
</div>
</form>
</div>
</div>
<div aria-labelledby="clearPointsTitle" aria-modal="true" class="modal" id="clearPointsModal" role="dialog">
  <div class="panel">
    <h3 id="clearPointsTitle">æ‰€æŒãƒã‚¤ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆ</h3>
    <p class="muted2">ç¾åœ¨ã®æ‰€æŒãƒã‚¤ãƒ³ãƒˆï¼š<strong id="clearPointsBalance">0</strong> pt</p>
    <p class="muted2">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="actions" style="justify-content:flex-end; margin-top:18px">
      <button class="btn" id="clearPointsCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn err" id="clearPointsConfirm" type="button">å…¨ã¦å‰Šé™¤</button>
    </div>
  </div>
</div>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const form = $('#taskForm');
  const listEl = $('#list');
  const emptyEl = $('#empty');
  const totalEl = $('#totalPoints .total');
  const breakdownEl = $('#breakdown');
  const modeEl = $('#mode');
  const condRow = $('#condRow');
  const schedRow = $('#schedRow');
  const filterButtons = $$('#listFilters [data-filter]');
  const loginModal = $('#loginModal');
  const loginForm = $('#loginForm');
  const accountNameEl = $('#accountName');
  const logoutBtn = $('#logoutBtn');
  const settingsBtn = $('#settingsBtn');
  const acctModal = $('#acctModal');
  const acctForm = $('#acctForm');
  const acctClose = $('#acctClose');
  const spendForm = $('#spendForm');
  const spendLogWrap = $('#spendLogWrap');
  const spendWarn = $('#spendWarn');
  const undoLastSpendBtn = $('#undoLastSpend');
  const spendListEl = document.querySelector('#spendList');
  const spendEmptyEl = document.querySelector('#spendEmpty');
  const rewardForm = $('#rewardForm');
  const rewardsListEl = $('#rewardsList');
  const rewardsEmptyEl = $('#rewardsEmpty');
  const rewardSelect = $('#rewardSelect');
  const clearPointsBtn = $('#clearPointsBtn');
  const clearPointsModal = $('#clearPointsModal');
  const clearPointsBalanceEl = $('#clearPointsBalance');
  const clearPointsCancel = $('#clearPointsCancel');
  const clearPointsConfirm = $('#clearPointsConfirm');
  let filter = 'all';

  // è¡¨ç¤ºãƒ»ä¿å­˜ã®ä¸Šé™ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´å¯ï¼‰
  const SPEND_LIST_LIMIT = 200;   // ç”»é¢ã«è¡¨ç¤ºã™ã‚‹æ¶ˆè²»å±¥æ­´ã®æœ€å¤§ä»¶æ•°ï¼ˆæ–°ã—ã„é †ï¼‰
  const SPEND_LOG_MAX   = 500;   // ä¿å­˜ã—ã¦ãŠãæœ€å¤§ä»¶æ•°ï¼ˆè¶…ãˆãŸã‚‰å¤ã„é †ã«è‡ªå‹•å‰Šé™¤ï¼‰

  const STORE_KEY = 'behavior-tracker-v4';
  const LEGACY_KEYS = ['behavior-tracker-v3','behavior-tracker-v2','behavior-tracker-v1'];
  // store = { currentUserId: string|null, users: { [id]: { passwordHash: string|null, items: [], spent:number, spendLog:[{id,what,amt,at}], earned:number } } }
  let store = { currentUserId:null, users:{} };
  let items = [];

  function normalizeItem(item){
    if(!item || typeof item !== 'object') return null;
    const diff = Number(item.difficulty);
    if(Number.isFinite(diff)){
      const clamped = Math.min(10, Math.max(1, Math.round(diff)));
      item.difficulty = clamped;
    } else {
      item.difficulty = 1;
    }
    const rawCount = Number(item.completedCount);
    if(Number.isFinite(rawCount) && rawCount > 0){
      item.completedCount = Math.floor(rawCount);
    } else {
      item.completedCount = item.done ? 1 : 0;
    }
    if(item.completedCount < 0) item.completedCount = 0;
    item.done = item.completedCount > 0;
    if(item.completedCount === 0){
      delete item.doneAt;
    }
    return item;
  }

  const USERNAME_PATTERN = /^[a-z0-9._-]{3,}$/;
  const normalizeId = (id)=> String(id).trim().toLowerCase();
  const findIdCaseInsensitive = (id)=>{
    const norm = normalizeId(id);
    return Object.keys(store.users).find(k => normalizeId(k) === norm) || null;
  }

  function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }
  function loadStore(){
    try{ store = JSON.parse(localStorage.getItem(STORE_KEY)||'{}') }catch{ store={} }
    if(!store || typeof store!== 'object') store = { currentUserId:null, users:{} };
    if(!store.users) store.users = {};

    // migrate older schemas
    for(const k of LEGACY_KEYS){
      const raw = localStorage.getItem(k); if(!raw) continue;
      try{
        const data = JSON.parse(raw);
        if((k==='behavior-tracker-v3' || k==='behavior-tracker-v2') && data && data.users){
          for(const [id, meta] of Object.entries(data.users)){
            const key = findIdCaseInsensitive(id) || normalizeId(id);
            if(!store.users[key]) store.users[key] = { passwordHash:null, items:[], spent:0, spendLog:[], earned:0 };
            store.users[key].passwordHash = meta.passwordHash || meta.pinHash || null;
            store.users[key].items = Array.isArray(meta.items)? meta.items : [];
            if(typeof meta.spent === 'number') store.users[key].spent = meta.spent;
            if(Array.isArray(meta.spendLog)) store.users[key].spendLog = meta.spendLog;
          }
          if(data.currentUserId) store.currentUserId = normalizeId(data.currentUserId);
        } else if(k==='behavior-tracker-v1' && Array.isArray(data)){
          const key='guest';
          store.users[key] = store.users[key]||{ passwordHash:null, items:[], spent:0, spendLog:[], earned:0 };
          store.users[key].items = data;
          if(!store.currentUserId) store.currentUserId = key;
        }
        localStorage.removeItem(k);
      }catch{}
    }
    saveStore();
  }

  function updateAccountDisplay(){
    const name = store.currentUserId || 'æœªãƒ­ã‚°ã‚¤ãƒ³';
    if(accountNameEl){ accountNameEl.textContent = name; }
    if(settingsBtn){
      const label = store.currentUserId ? `è¨­å®šï¼ˆ${store.currentUserId}ï¼‰` : 'è¨­å®š';
      settingsBtn.setAttribute('aria-label', label);
      settingsBtn.setAttribute('title', label);
    }
  }

  const SHA256_K = new Uint32Array([
    0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,
    0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,
    0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,
    0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,
    0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,
    0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,
    0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,
    0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2
  ]);

  function sha256Fallback(text){
    let enc;
    if(typeof TextEncoder !== 'undefined'){
      enc = new TextEncoder().encode(text);
    } else {
      const str = unescape(encodeURIComponent(String(text)));
      enc = new Uint8Array(str.length);
      for(let i=0; i<str.length; i++){ enc[i] = str.charCodeAt(i); }
    }
    const bitLen = enc.length * 8;
    const dataLength = ((bitLen + 64) >>> 9 << 4) + 16;
    const data = new Uint32Array(dataLength);
    for(let i=0; i<enc.length; i++){
      data[i >> 2] |= enc[i] << ((3 - (i & 3)) * 8);
    }
    data[bitLen >> 5] |= 0x80 << (24 - (bitLen & 31));
    data[dataLength - 1] = bitLen;

    const w = new Uint32Array(64);
    const ROTR = (x, n)=> (x >>> n) | (x << (32 - n));
    const SHR = (x, n)=> x >>> n;

    let a=0x6a09e667, b=0xbb67ae85, c=0x3c6ef372, d=0xa54ff53a;
    let e=0x510e527f, f=0x9b05688c, g=0x1f83d9ab, h=0x5be0cd19;

    for(let i=0; i<dataLength; i+=16){
      for(let t=0; t<64; t++){
        if(t<16){ w[t] = data[i+t] >>> 0; }
        else {
          const s0 = ROTR(w[t-15],7) ^ ROTR(w[t-15],18) ^ SHR(w[t-15],3);
          const s1 = ROTR(w[t-2],17) ^ ROTR(w[t-2],19) ^ SHR(w[t-2],10);
          w[t] = (w[t-16] + s0 + w[t-7] + s1) >>> 0;
        }
      }

      let A=a, B=b, C=c, D=d, E=e, F=f, G=g, H=h;
      for(let t=0; t<64; t++){
        const S1 = ROTR(E,6) ^ ROTR(E,11) ^ ROTR(E,25);
        const ch = (E & F) ^ ((~E) & G);
        const temp1 = (H + S1 + ch + SHA256_K[t] + w[t]) >>> 0;
        const S0 = ROTR(A,2) ^ ROTR(A,13) ^ ROTR(A,22);
        const maj = (A & B) ^ (A & C) ^ (B & C);
        const temp2 = (S0 + maj) >>> 0;

        H = G;
        G = F;
        F = E;
        E = (D + temp1) >>> 0;
        D = C;
        C = B;
        B = A;
        A = (temp1 + temp2) >>> 0;
      }

      a = (a + A) >>> 0;
      b = (b + B) >>> 0;
      c = (c + C) >>> 0;
      d = (d + D) >>> 0;
      e = (e + E) >>> 0;
      f = (f + F) >>> 0;
      g = (g + G) >>> 0;
      h = (h + H) >>> 0;
    }

    return [a,b,c,d,e,f,g,h].map(x=>x.toString(16).padStart(8,'0')).join('');
  }

  function getCryptoSubtle(){
    try{
      const scope =
        (typeof globalThis === 'object' && globalThis) ||
        (typeof self === 'object' && self) ||
        (typeof window === 'object' && window) ||
        (typeof global === 'object' && global) ||
        null;
      if(!scope || !scope.crypto){ return null; }
      const cryptoObj = scope.crypto;
      return cryptoObj.subtle || cryptoObj.webkitSubtle || cryptoObj.msSubtle || null;
    }catch(err){
      console.warn('sha256Hex: unable to access crypto.subtle', err);
      return null;
    }
  }

  async function sha256Hex(text){
    const subtle = getCryptoSubtle();
    if(subtle){
      try{
        if(typeof TextEncoder === 'undefined'){ throw new Error('TextEncoder unavailable'); }
        const enc = new TextEncoder().encode(text);
        const buf = await subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(err){
        console.warn('sha256Hex: falling back to JS implementation', err);
      }
    }
    return sha256Fallback(text);
  }

  // Login / Create (case-insensitive id, password required)
  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const rawId = String($('#userId').value||'');
    const pw = String($('#password').value||'');
    if(!rawId){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const id = normalizeId(rawId);
    if(!USERNAME_PATTERN.test(id)){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯åŠè§’è‹±æ•°å­—ãƒ»._-ã§3æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'); return; }
    if(!pw){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if(pw.length < 6 && !confirm('6æ–‡å­—æœªæº€ã§ã™ã€‚æœ¬å½“ã«ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

    const hash = await sha256Hex(pw);
    const existingId = findIdCaseInsensitive(id);

    if(existingId){
      const meta = store.users[existingId];
      if(!meta.passwordHash){ meta.passwordHash = hash; saveStore(); alert('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ'); }
      if(hash !== meta.passwordHash){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
      setCurrentUser(existingId);
    } else {
      store.users[id] = { passwordHash: hash, items: [], spent:0, spendLog:[], earned:0 };
      saveStore(); setCurrentUser(id);
    }
  });

  settingsBtn.addEventListener('click', ()=>{
    if(!store.currentUserId){ alert('ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    updateAccountDisplay();
    $('#currPw').value=''; $('#newPw').value=''; $('#newPw2').value='';
    acctModal.classList.add('on');
  });
  acctClose.addEventListener('click', ()=> acctModal.classList.remove('on'));
  if(clearPointsBtn){
    clearPointsBtn.addEventListener('click', ()=>{
      if(!store.currentUserId){ alert('ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
      if(clearPointsBalanceEl) clearPointsBalanceEl.textContent = String(balance());
      if(clearPointsModal) clearPointsModal.classList.add('on');
    });
  }
  if(clearPointsCancel){
    clearPointsCancel.addEventListener('click', ()=>{ if(clearPointsModal) clearPointsModal.classList.remove('on'); });
  }
  if(clearPointsModal){
    clearPointsModal.addEventListener('click', (e)=>{ if(e.target === clearPointsModal) clearPointsModal.classList.remove('on'); });
  }
  if(clearPointsConfirm){
    clearPointsConfirm.addEventListener('click', ()=>{
      if(!store.currentUserId){ alert('ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
      resetAllPoints();
      if(clearPointsModal) clearPointsModal.classList.remove('on');
      alert('æ‰€æŒãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    });
  }
  if (document.getElementById('showPw1')) { document.getElementById('showPw1').addEventListener('change', (e)=>{ document.getElementById('password').type = e.target.checked ? 'text':'password'; }); }
  if (document.getElementById('showPw2')) { document.getElementById('showPw2').addEventListener('change', (e)=>{ document.getElementById('currPw').type = e.target.checked ? 'text':'password'; }); }
  if (document.getElementById('showPw3')) { document.getElementById('showPw3').addEventListener('change', (e)=>{ document.getElementById('newPw').type = e.target.checked ? 'text':'password'; }); }

  acctForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const uid = store.currentUserId; if(!uid) return;
    const meta = store.users[uid] || { passwordHash:null };
    const curr = String($('#currPw').value||'');
    const n1 = String($('#newPw').value||'');
    const n2 = String($('#newPw2').value||'');
    if(!n1){ alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if(n1.length < 6 && !confirm('6æ–‡å­—æœªæº€ã§ã™ã€‚æœ¬å½“ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
    if(n1 !== n2){ alert('ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
    if(meta.passwordHash){
      if(!curr){ alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const h = await sha256Hex(curr); if(h !== meta.passwordHash){ alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
    }
    meta.passwordHash = await sha256Hex(n1); store.users[uid] = meta; saveStore(); alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); acctModal.classList.remove('on');
  });

  logoutBtn.addEventListener('click', ()=>{
    store.currentUserId = null;
    saveStore();
    items = [];
    render();
    updateAccountDisplay();
    acctModal.classList.remove('on');
    loginModal.classList.add('on');
  });

  // Persistence helpers
  function ensureUserMeta(){
    const uid = store.currentUserId; if(!uid) return null;
    store.users[uid] = store.users[uid] || { passwordHash:null, items:[], spent:0, spendLog:[], earned:0 };
    const meta = store.users[uid];
    if(!Array.isArray(meta.items)) meta.items = [];
    for(let i=0; i<meta.items.length; i++){
      if(!normalizeItem(meta.items[i])){ meta.items.splice(i,1); i--; }
    }
    if(typeof meta.spent !== 'number') meta.spent = 0;
    if(!Array.isArray(meta.spendLog)) meta.spendLog = [];
    if(typeof meta.earned !== 'number') meta.earned = 0;
    if(!Array.isArray(meta.rewards)) meta.rewards = [];
    return meta;
  }
  function save(){
    const meta = ensureUserMeta(); if(!meta) return;
    items.forEach(normalizeItem);
    meta.items = items;
    saveStore();
  }

  // Points
  function earnedPoints(){
    const meta = ensureUserMeta();
    const fromList = items.reduce((total, item)=>{
      const diff = Number(item.difficulty) || 0;
      const count = Math.max(0, Number(item.completedCount) || 0);
      return total + diff * count;
    }, 0);
    const acc = meta? (meta.earned||0) : 0;
    return fromList + acc;
  }
  function spentPoints(){ const meta = ensureUserMeta(); return meta? (meta.spent||0) : 0; }
  function balance(){ return Math.max(0, earnedPoints() - spentPoints()); }

  function resetAllPoints(){
    const meta = ensureUserMeta(); if(!meta) return;
    items.forEach(item=>{
      item.completedCount = 0;
      item.done = false;
      delete item.doneAt;
    });
    meta.earned = 0;
    meta.spent = 0;
    meta.spendLog = [];
    save();
    render();
  }

  function renderSpendLog(){
    const meta = ensureUserMeta(); if(!meta) return;
    const logs = meta.spendLog||[];
    if(!logs.length){ spendLogWrap.innerHTML = 'æ¶ˆè²»å±¥æ­´ï¼šãªã—'; return; }
    const last = logs[logs.length-1];
    const fmt = (t)=>{ const d=new Date(t); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'); return `${y}/${m}/${da} ${hh}:${mm}` };
    spendLogWrap.innerHTML = `æ¶ˆè²»å±¥æ­´ï¼ˆæœ€æ–°1ä»¶è¡¨ç¤ºï¼‰ï¼šã€Œ${escapeHtml(last.what)}ã€ã« ${last.amt}pt - ${fmt(last.at)}`;
  }

  function render(){
    listEl.innerHTML='';
    const visible = items.slice().sort((a,b)=>{
      const getTs = (x)=> x.mode==='sched' && x.date ? new Date(x.date + (x.time? 'T'+x.time : 'T00:00')).getTime() : x.createdAt;
      return getTs(a) - getTs(b);
    }).filter(i=>{
      if(filter==='cond') return i.mode==='cond';
      if(filter==='sched') return i.mode==='sched';
      return true;
    });
    visible.forEach(item=> listEl.appendChild(renderItem(item)) );
    emptyEl.style.display = visible.length? 'none':'block';
    // header points
    totalEl.textContent = String(balance());
    breakdownEl.textContent = `(å–å¾— ${earnedPoints()} / æ¶ˆè²» ${spentPoints()})`;
    filterButtons.forEach(b=> b.setAttribute('aria-pressed', String(b.dataset.filter===filter)) );
    renderRewards();
    renderSpendLog();
    renderSpendList();
  }

  function renderItem(item){
    const el = document.createElement('article');
    el.className = 'item fade-in';
    const dd = item.mode==='sched' && item.date ? formatDateTime(item.date, item.time) : null;
    const count = Math.max(0, Number(item.completedCount) || 0);
    const completionNote = count>0 ? `<div class="hint" style="margin:0 0 8px">ç´¯è¨ˆé”æˆï¼š${count}å›</div>` : '';
    const undoButton = count>0 ? `<button class="btn ok icon" data-act="undo" data-id="${item.id}">âœ… 1å›æˆ»ã™ (-${item.difficulty}pt)</button>` : '';
    el.innerHTML = `
      <div class="item-head">
        <span class="badge">${item.mode==='sched' ? 'æ—¥ç¨‹' : 'æ¡ä»¶'}</span>
        <div class="title">${escapeHtml(item.title)}</div>
        <div class="spacer"></div>
        <div class="badge" title="é›£æ˜“åº¦">${item.difficulty} pt</div>
      </div>
      <div class="muted" style="margin:6px 0 10px">${ item.mode==='sched' ? (dd? `<span class="date">${dd}</span>`:'<span class="date">æ—¥ç¨‹æœªè¨­å®š</span>') : (item.condition? escapeHtml(item.condition) : 'æ¡ä»¶æœªè¨­å®š') }</div>
      ${completionNote}
      <div class="bar" aria-hidden="true"><i style="width:${(item.difficulty/10)*100}%"></i></div>
      <div class="actions controls" style="margin-top:10px">
        <button class="btn ok icon" data-act="done" data-id="${item.id}">âœ” é”æˆ (+${item.difficulty}pt)</button>
        ${undoButton}
        <button class="btn icon" data-act="edit" data-id="${item.id}">âœ ç·¨é›†</button>
        <button class="btn err icon" data-act="del" data-id="${item.id}">ğŸ—‘ å‰Šé™¤</button>
      </div>`;
    return el;
  }

  // âœ… ã‚¯ãƒªãƒƒã‚¯å§”è­²ã§å®‰å®šåŒ–ï¼ˆå‰Šé™¤/é”æˆ/ç·¨é›†ï¼‰
  listEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act]'); if(!btn) return;
    e.preventDefault();
    const id = btn.dataset.id; const act = btn.dataset.act;
    const idx = items.findIndex(x=>x.id===id); if(idx<0) return;
    const it = items[idx];
    if(act==='done'){
      if(!it) return;
      normalizeItem(it);
      const current = Math.max(0, Number(it.completedCount) || 0);
      it.completedCount = current + 1;
      it.done = true;
      it.doneAt = Date.now();
      save(); render();
      return;
    }
    if(act==='undo'){
      if(!it) return;
      normalizeItem(it);
      const current = Math.max(0, Number(it.completedCount) || 0);
      if(current <= 0) return;
      it.completedCount = current - 1;
      if(it.completedCount <= 0){
        it.done = false;
        delete it.doneAt;
      }
      save(); render();
      return;
    }
    if(act==='del'){
      if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
        const meta = ensureUserMeta();
        if(meta && it){
          const count = Math.max(0, Number(it.completedCount) || 0);
          const diff = Math.max(0, Number(it.difficulty) || 0);
          const reclaimed = count * diff;
          if(reclaimed > 0){
            const base = Number(meta.earned) || 0;
            meta.earned = base + reclaimed;
          }
        }
        items.splice(idx,1);
        save();
        render();
      }
    }
    if(act==='edit' && it){
      $('#title').value = it.title; $('#mode').value = it.mode; toggleMode();
      $('#condition').value = it.condition||''; $('#date').value = it.date||''; $('#time').value = it.time||'';
      $('#difficulty').value = it.difficulty; $('#diffOut').textContent = it.difficulty;
      form.dataset.editing = it.id; window.scrollTo({top:0, behavior:'smooth'});
    }
  });

  function toggleMode(){ const m = modeEl.value; condRow.style.display = m==='cond'? 'grid':'none'; schedRow.style.display = m==='sched'? 'grid':'none'; }
  function formatDateTime(d,t){ try{ const dt = new Date(d + (t? 'T'+t : 'T00:00')); const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), da=String(dt.getDate()).padStart(2,'0'), hh=String(dt.getHours()).padStart(2,'0'), mm=String(dt.getMinutes()).padStart(2,'0'); return `${y}/${m}/${da}${t? ` ${hh}:${mm}`:''}` }catch{ return d } }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

  function fmtTs(ts){ try{ const d=new Date(ts); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'); return `${y}/${m}/${da} ${hh}:${mm}` } catch { return String(ts) } }

  function renderRewards(){
    const meta = ensureUserMeta(); if(!meta) return;
    const rewards = meta.rewards||[];
    // populate select
    if(rewardSelect){
      const sel = rewardSelect; const cur = sel.value;
      sel.innerHTML = '<option value="" disabled selected>ã”è¤’ç¾ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' + rewards.map(r=>`<option value="${r.id}">${escapeHtml(r.name)}ï¼ˆ${r.cost}ptï¼‰</option>`).join('');
      if(cur && rewards.some(r=>r.id===cur)) sel.value = cur;
    }
    // list render
    if(!rewards.length){ rewardsListEl.innerHTML=''; rewardsEmptyEl.style.display='block'; return; }
    rewardsEmptyEl.style.display='none';
    rewardsListEl.innerHTML='';
    rewards.forEach(r=>{
      const el = document.createElement('article');
      el.className='item fade-in';
      el.innerHTML = `
        <div class="item-head">
          <span class="badge">ã”è¤’ç¾</span>
          <div class="title">${escapeHtml(r.name)}</div>
          <div class="spacer"></div>
          <div class="badge">${r.cost} pt</div>
        </div>
        <div class="actions controls" style="margin-top:8px">
          <button class="btn err icon" data-reward-del="${r.id}">ğŸ—‘ å‰Šé™¤</button>
        </div>`;
      rewardsListEl.appendChild(el);
    });
  }

  function renderSpendList(){
    const meta = ensureUserMeta(); if(!meta){ spendListEl.innerHTML=''; spendEmptyEl.style.display='block'; return; }
    const logs = (meta.spendLog||[]).slice().sort((a,b)=> b.at - a.at).slice(0, SPEND_LIST_LIMIT);
    spendListEl.innerHTML='';
    if(!logs.length){ spendEmptyEl.style.display='block'; return; }
    spendEmptyEl.style.display='none';
    const note = document.createElement('div');
    note.className='hint';
    note.textContent = `æœ€æ–°${Math.min(SPEND_LIST_LIMIT, logs.length)}ä»¶ã‚’è¡¨ç¤ºï¼ˆå¤ã„å±¥æ­´ã¯è‡ªå‹•ã§é–“å¼•ãï¼‰`;
    spendListEl.appendChild(note);
    logs.forEach(log=>{
      const el = document.createElement('article');
      el.className='item fade-in';
      el.innerHTML = `
        <div class="item-head">
          <span class="badge">æ¶ˆè²»</span>
          <div class="title">${escapeHtml(log.what)}</div>
          <div class="spacer"></div>
          <div class="badge" title="æ¶ˆè²»pt">-${log.amt} pt</div>
        </div>
        <div class="muted" style="margin:6px 0 6px"><span class="date">${fmtTs(log.at)}</span></div>
        <div class="bar" aria-hidden="true"><i style="width:${Math.min(100, (log.amt/10)*100)}%"></i></div>
      `;
      spendListEl.appendChild(el);
    });
  }

  // Form events
  modeEl.addEventListener('change', toggleMode);
  form.addEventListener('submit', (e)=>{
    e.preventDefault(); if(!store.currentUserId){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    const data = new FormData(form);
    const title = String(data.get('title')||'').trim(); if(!title){ alert('è¡Œå‹•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return }
    const mode = data.get('mode'); const difficulty = Number(data.get('difficulty')||5);
    let condition = '', date='', time='';
    if(mode==='cond'){ condition = String(data.get('condition')||'').trim(); }
    else{ date = String(data.get('date')||''); time = String(data.get('time')||''); }
    const editingId = form.dataset.editing;
    if(editingId){
      const i = items.findIndex(x=>x.id===editingId);
      if(i>=0){
        const meta = ensureUserMeta();
        const target = items[i];
        const prevCount = Math.max(0, Number(target.completedCount) || 0);
        const prevDiff = Number(target.difficulty) || 0;
        const prevPoints = prevCount * prevDiff;
        Object.assign(target, { title, mode, condition, date, time, difficulty });
        normalizeItem(target);
        const nextDiff = Number(target.difficulty) || 0;
        const nextPoints = prevCount * nextDiff;
        if(meta){
          const earned = Number(meta.earned) || 0;
          meta.earned = earned + (prevPoints - nextPoints);
        }
      }
      delete form.dataset.editing;
    }
    else{
      const newItem = {id:uid(), title, mode, condition, date, time, difficulty, completedCount:0, done:false, createdAt:Date.now()};
      normalizeItem(newItem);
      items.push(newItem);
    }
    save(); render(); form.reset(); toggleMode(); $('#diffOut').textContent = $('#difficulty').value;
  });
  $('#resetBtn').addEventListener('click', ()=>{ delete form.dataset.editing; toggleMode(); $('#diffOut').textContent = $('#difficulty').value; });

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  filterButtons.forEach(btn=> btn.addEventListener('click', ()=>{ filter = btn.dataset.filter; render(); }));

  // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
  spendForm.addEventListener('submit', (e)=>{
    e.preventDefault(); const meta = ensureUserMeta(); if(!meta){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    const rewards = meta.rewards||[]; const rid = rewardSelect && rewardSelect.value;
    const reward = rewards.find(r=> r.id===rid);
    if(!reward){ alert('ã”è¤’ç¾ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const what = reward.name; const amt = Math.max(1, Math.floor(Number(reward.cost||1)));
    if(balance() < amt){
      try{ if(spendWarn){ spendWarn.textContent = 'ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼'; spendWarn.style.display='block'; setTimeout(()=>{ if(spendWarn) spendWarn.style.display='none'; }, 2500); } }catch{}
      alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
      return;
    }
    meta.spent = (meta.spent||0) + amt; meta.spendLog = meta.spendLog||[]; meta.spendLog.push({id:uid(), what, amt, at:Date.now(), rewardId: rid});
    if(meta.spendLog.length > SPEND_LOG_MAX){ meta.spendLog.splice(0, meta.spendLog.length - SPEND_LOG_MAX); }
    saveStore(); render(); if(rewardSelect) rewardSelect.value='';
  });
  undoLastSpendBtn.addEventListener('click', ()=>{
    const meta = ensureUserMeta(); if(!meta) return;
    const logs = meta.spendLog||[]; if(!logs.length){ alert('å–ã‚Šæ¶ˆã™æ¶ˆè²»ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const last = logs.pop(); meta.spent = Math.max(0, (meta.spent||0) - (last.amt||0)); saveStore(); render();
  });

  // Rewards: add/delete
  rewardForm.addEventListener('submit', (e)=>{
    e.preventDefault(); const meta = ensureUserMeta(); if(!meta){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    const name = String($('#rewardName').value||'').trim(); const cost = Math.max(1, Math.floor(Number($('#rewardCost').value||1)));
    if(!name){ alert('ã”è¤’ç¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    meta.rewards = meta.rewards||[]; meta.rewards.push({ id: uid(), name, cost });
    saveStore(); $('#rewardForm').reset(); renderRewards();
  });
  rewardsListEl.addEventListener('click', (e)=>{
    const delBtn = e.target.closest('[data-reward-del]'); if(!delBtn) return;
    const id = delBtn.getAttribute('data-reward-del'); const meta = ensureUserMeta(); if(!meta) return;
    const i = (meta.rewards||[]).findIndex(r=> r.id===id); if(i<0) return;
    if(confirm('ã“ã®ã”è¤’ç¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ meta.rewards.splice(i,1); saveStore(); renderRewards(); }
  });

  function today(offset=0){ const dt=new Date(); dt.setDate(dt.getDate()+offset); const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const d=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${d}` }
  function uid(){return Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)}

  function setCurrentUser(id){
    store.currentUserId = id; saveStore();
    const meta = ensureUserMeta();
    items = meta.items || [];
    items.forEach(normalizeItem);
    render();
    updateAccountDisplay();
    loginModal.classList.remove('on');
  }

  loadStore();
  updateAccountDisplay();
  if(store.currentUserId && store.users[store.currentUserId]){ setCurrentUser(store.currentUserId); } else { loginModal.classList.add('on'); }
  toggleMode();

  /* =====================
     Lightweight runtime tests (non-intrusive)
     ===================== */
  (function devTests(){
    try{
      console.assert(USERNAME_PATTERN.test('user_01'), 'USERNAME_PATTERN should accept safe ids');
      console.assert(!USERNAME_PATTERN.test('ã‚'), 'USERNAME_PATTERN should reject non-ascii');
      (async()=>{ const h = await sha256Hex('test'); console.assert(h.length===64, 'sha256 length 64'); })();
      console.assert(escapeHtml('<>&"\'"') === '&lt;&gt;&amp;&quot;&#39;', 'escapeHtml works');
      console.assert(/^\d{4}-\d{2}-\d{2}$/.test(today()), 'today format');
    }catch(err){ console.warn('devTests warning:', err); }
  })();

})();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    });
  }
</script></body>
</html>
